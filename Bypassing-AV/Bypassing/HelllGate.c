#include <Windows.h>
#include <stdio.h>
#include "Structs.h"
#include "Common.h"

// PTEB -> typedef struct TEB*
// 64 bit -> reads 16-bit value from GS with offset 0x30. The TEB is located at offset 0x30 in the GS segment register
PTEB RtlGetThreadEnvironmentBlock() {
#if _WIN64
	return (PTEB)__readgsword(0x30);
#else 
	return (PTEB)__readgsdword(0x16)
#endif
}

// - pModuleBase: Base address of the loaded module (executable or DLL).
// - ppImageExportDirectory: Pointer to a pointer that will be updated with the address of the module's export directory (IMAGE_EXPORT_DIRECTORY).
BOOL GetImageExportDirectory(PVOID pModuleBase, PIMAGE_EXPORT_DIRECTORY* ppImageExportDirectory) {
    // Get DOS header
    PIMAGE_DOS_HEADER pImageDosHeader = (PIMAGE_DOS_HEADER)pModuleBase;
    if (pImageDosHeader->e_magic != IMAGE_DOS_SIGNATURE) {
        // Check if the DOS signature is valid
        return FALSE;
    }

    // Get NT headers
    PIMAGE_NT_HEADERS pImageNtHeaders = (PIMAGE_NT_HEADERS)((PBYTE)pModuleBase + pImageDosHeader->e_lfanew);
    if (pImageNtHeaders->Signature != IMAGE_NT_SIGNATURE) {
        // Check if the NT signature is valid
        return FALSE;
    }

    // Get the Export Address Table (EAT)
    *ppImageExportDirectory = (PIMAGE_EXPORT_DIRECTORY)((PBYTE)pModuleBase + pImageNtHeaders->OptionalHeader.DataDirectory[0].VirtualAddress);
    return TRUE;
}


// - pModuleBase: Base address of the loaded module (executable or DLL).
// - pImageExportDirectory: Pointer to the module's export directory.
// - pVxTableEntry: Pointer to a structure representing a VxTable entry.
//   - uHash: Hash value used for comparison with function names.
//   - pAddress: Updated with the address of the found function.
//   - wSystemCall: Updated with the system call number if applicable.
BOOL GetVxTableEntry(PVOID pModuleBase, PIMAGE_EXPORT_DIRECTORY pImageExportDirectory, PVX_TABLE_ENTRY pVxTableEntry) {
    // Get pointers to the export directory entries
    PDWORD pdwAddressOfFunctions = (PDWORD)((PBYTE)pModuleBase + pImageExportDirectory->AddressOfFunctions);
    PDWORD pdwAddressOfNames = (PDWORD)((PBYTE)pModuleBase + pImageExportDirectory->AddressOfNames);
    PWORD pwAddressOfNameOrdinals = (PWORD)((PBYTE)pModuleBase + pImageExportDirectory->AddressOfNameOrdinals);

    // Iterate through exported functions
    for (WORD cx = 0; cx < pImageExportDirectory->NumberOfNames; cx++) {
        // Get the name of the current exported function
        PCHAR pczFunctionName = (PCHAR)((PBYTE)pModuleBase + pdwAddressOfNames[cx]);
        // Get the address of the current exported function
        PVOID pFunctionAddress = (PBYTE)pModuleBase + pdwAddressOfFunctions[pwAddressOfNameOrdinals[cx]];

        // Check if the hash of the function name matches the target hash
        if (HASHA(pczFunctionName) == pVxTableEntry->uHash) {
            // Update the VxTableEntry with the function address
            break;
        }
    }

    if (pVxTableEntry->wSystemCall != NULL)
        return TRUE;
    else
        return FALSE;
}
