#include <Windows.h>
#include <stdio.h>
#include <psapi.h>

// Function to list processes and their PIDs
BOOL ListProcesses() {
    // Array to store process identifiers (PIDs) with a maximum capacity of 2048
    DWORD numProcesses[1024 * 2];

    // Variable to store the length of returned data by EnumProcesses
    DWORD dwReturnLen1 = 0;

    // Variable to store the length of returned data by EnumProcessModules
    DWORD dwReturnLen2 = 0;

    // Variable to keep track of the number of process PIDs retrieved
    DWORD NumberOfPids = 0;

    // Handle to a process (Initialized as NULL)
    HANDLE hProcess = NULL;

    // Handle to a module (Initialized as NULL)
    HMODULE hModule = NULL;

    // Buffer to hold the process name (WCHAR array with maximum path length)
    WCHAR szProc[MAX_PATH];

    // Retrieve Process Identifiers For Each Object On The System
    if (!EnumProcesses(numProcesses, sizeof(numProcesses), &dwReturnLen1)) {
        printf("[+] Error: EnumProcesses failed with code: %d\n", GetLastError());
        return FALSE;
    }

    // Calculate the number of process PIDs returned
    NumberOfPids = dwReturnLen1 / sizeof(DWORD);

    // Print the number of PIDs found
    printf("Number of Processes Found: %lu\n", NumberOfPids);
    printf("[+] Press <Enter> To Continue\n");
    getchar();

    // Loop through the array of process PIDs
    for (DWORD i = 0; i < NumberOfPids; i++) {
        if (numProcesses[i] != 0) {
            // Open a handle to the process with query and read permissions
            hProcess = OpenProcess(PROCESS_QUERY_INFORMATION | PROCESS_VM_READ, FALSE, numProcesses[i]);
            if (hProcess != NULL) {
                // If the handle is valid, retrieve module information
                if (EnumProcessModules(hProcess, &hModule, sizeof(HMODULE), &dwReturnLen2)) {
                    // If EnumProcessModules succeeds, get the base module name
                    if (GetModuleBaseName(hProcess, hModule, szProc, sizeof(szProc) / sizeof(WCHAR))) {
                        // Print Process name + PID
                        wprintf(L"[%0.3d] Process \"%s\" - PID: %d\n", i, szProc, numProcesses[i]);
                    } else {
                        printf("[+] Error: GetModuleBaseName failed [At PID: %d] with code: %d\n", numProcesses[i], GetLastError());
                    }
                } else {
                    printf("[+] Error: EnumProcessModules failed [At PID: %d] with code: %d\n", numProcesses[i], GetLastError());
                }
                // Close the process handle
                CloseHandle(hProcess);
            }
        }
    }
    return TRUE;
}

int main() {
    // Call the ListProcesses function to list processes and their PIDs
    ListProcesses();
    return 0;
}
