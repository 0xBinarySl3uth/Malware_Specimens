/*
	Explaination:
		- The minhook library works by initializaing a structure that holds the required information needed for the hook's installation and removal.
		- This is done via; MH_Initialize API, that initialized the HOOK Entry structure in the library
		
		MH_Initialize - Initializes the HOOK_ENTRY structure.
		MH_CreateHook - Create the hooks.
		MH_EnableHook - Enables the created hooks.
		MH_DisableHook - Remove the hooks.
		MH_Uninitialize - Cleanup the initialized structure.

*/

#include <Windows.h>
#include <stdio.h>
#include "MinHook.h"

// If compiling as 64-bit
#ifdef _M_X64
#pragma comment (lib, "detoursx64.lib")
#endif // _M_X64

// If compiling as 32-bit
#ifdef _M_IX86
#pragma comment (lib, "detoursx86.lib")
#endif // _M_IX86

// Function pointer for running function hooking
// WINAPI* -> Calling convention (specifies the rules for how the function is called; in this case, default WinAPI calling convention)
typedef int (WINAPI* fnMessageBoxA)(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT uType);

// Function pointer assigned to variable pMessageBoxA, which is assigned to MessageBoxA, allowing for dynamic usage of MessageBoxA
fnMessageBoxA pMessageBoxA = MessageBoxA;

// Function that will run MessageBoxA when hooked
INT WINAPI MyMessageBoxA(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT uType) {
	printf("[*] Parameters When API Hooking Failed: \n");
	printf("\t[*] Long Pointer Constant String lpText: %s \n", lpText);
	printf("\t[*] Long Pointer Constant String lpCaption: %s \n", lpCaption);

	// Call the original MessageBoxA
	return pMessageBoxA(hWnd, "Malware Development - Hooked API", "Hooked MsgBox", uType);
}

/*
typedef struct _HOOK_ENTRY
{
	LPVOID pTarget;             // Address of the target function.
	LPVOID pDetour;             // Address of the detour or relay function.
	LPVOID pTrampoline;         // Address of the trampoline function.
	UINT8  backup[8];           // Original prologue of the target function.

	UINT8  patchAbove  : 1;     // Uses the hot patch area.
	UINT8  isEnabled   : 1;     // Enabled.
	UINT8  queueEnable : 1;     // Queued for enabling/disabling when != isEnabled.

	UINT   nIP : 4;             // Count of the instruction boundaries.
	UINT8  oldIPs[8];           // Instruction boundaries of the target function.
	UINT8  newIPs[8];           // Instruction boundaries of the trampoline function.
} HOOK_ENTRY, *PHOOK_ENTRY;

*/
BOOL Hook() {
	DWORD dwMinhookError = NULL;

	// Initialize the HOOK Entry Structure
	if ((dwMinhookError = MH_Initialize()) != MH_OK) {
		printf("[!] MH_Initialize Failed With Error Code: %d \n", dwMinhookError);
		return 1;
	}

	// Inserting hook to run MyMessageBoxA (disabled state)
	if ((dwMinhookError = MH_CreateHook(&MessageBoxA, &MyMessageBoxA, &pMessageBoxA)) != MH_OK) {
		printf("[!] MH_CreateHook Failed With Error Code: %d \n", dwMinhookError);
		return FALSE;
	}

	// Enable Hook 
	if ((dwMinhookError = MH_EnableHook(&MessageBoxA)) != MH_OK) {
		printf("[!] MH_EnableHook Failed With Error Code: %d \n", dwMinhookError);
		return -1;
	}
	return TRUE;
}

BOOL Unhook() {

	DWORD		dwMinHookError = NULL;

	// Disbale hook
	if ((dwMinHookError = MH_DisableHook(&MessageBoxA)) != MH_OK) {
		printf("[!] MH_DisableHook Failed With Error : %d \n", dwMinHookError);
		return -1;
	}

	// Uninitialize Hook Entry struct
	if ((dwMinHookError = MH_Uninitialize()) != MH_OK) {
		printf("[!] MH_Uninitialize Failed With Error : %d \n", dwMinHookError);
		return -1;
	}
}

int main() {
	// Original MessageBoxA call
	MessageBoxA(NULL, "Original MessageBox", "Original", MB_OK);

	printf("[+] Press <Enter> To Start API Hooking\n");
	getchar();

	// Attempt API hooking
	if (!Hook()) {
		printf("[!] API Hooking Failed!\n");
		return 1;
	}

	// MessageBoxA test, it should not be able to run since it's hooked
	MessageBoxA(NULL, "0xBinary", "MessageBox", MB_OK);

	printf("[+] Press <Enter> To Unhook \n");
	getchar();

	// Attempt to unhook
	if (!Unhook()) {
		printf("[!] Unhook Failed \n");
		return 1;
	}

	// MessageBoxA test, you should be able to see this messagebox
	MessageBoxA(NULL, "Unhooking - Done", "Unhook MessageBox", MB_OK);

	printf("[+] Press <Enter> To Quit ... ");
	getchar();

	return 0;
}
