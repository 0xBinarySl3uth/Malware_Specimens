/*
Explanation:
    - The Detours library allows us to intercept and redirect function calls in Windows.

Transactions:
    - The Detours library replaces the first few instructions of the target function (the function to be hooked) with an unconditional jump to a user-provided detour function.
    - The unconditional jump is also known as a trampoline.
    - The library uses transactions to install and uninstall hooks from a targeted function.
    - Transactions allow hooking routines to group multiple function hooks together and apply them as a single unit.
*/

#include <Windows.h>
#include <stdio.h>
#include "detours.h"
#include "syelog.h"
#include "detver.h"

// If compiling as 64-bit
#ifdef _M_X64
#pragma comment (lib, "detoursx64.lib")
#endif // _M_X64

// If compiling as 32-bit
#ifdef _M_IX86
#pragma comment (lib, "detoursx86.lib")
#endif // _M_IX86

// Function pointer for running function hooking
// WINAPI* -> Calling convention (specifies the rules for how the function is called; in this case, default WinAPI calling convention)
typedef int (WINAPI* fnMessageBoxA)(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT uType);

// Function pointer assigned to variable pMessageBoxA, which is assigned to MessageBoxA, allowing for dynamic usage of MessageBoxA
fnMessageBoxA pMessageBoxA = MessageBoxA;

// Function that will run MessageBoxA when hooked
INT WINAPI MyMessageBoxA(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT uType) {
    printf("[*] Parameters When API Hooking Failed: \n");
    printf("\t[*] Long Pointer Constant String lpText: %s \n", lpText);
    printf("\t[*] Long Pointer Constant String lpCaption: %s \n", lpCaption);

    // Call the original MessageBoxA
    return pMessageBoxA(hWnd, "Malware Development - Hooked API", "Hooked MsgBox", uType);
}

// Function that performs Detours unhooking
BOOL Unhook() {
    DWORD dwDetourError = NULL; // Variable to store Detours-related error codes.

    // Start a new transaction to begin the process of unhooking the target function.
    if ((dwDetourError = DetourTransactionBegin()) != NO_ERROR) {
        printf("[!] DetourTransactionBegin Failed With Error Code: %d \n", dwDetourError);
        return FALSE;
    }

    // Update the current thread handle (handle to itself).
    if ((dwDetourError = DetourUpdateThread(GetCurrentThread())) != NO_ERROR) {
        printf("[!] DetourUpdateThread Failed With Error Code: %d \n", dwDetourError);
        return FALSE;
    }

    // Detach the transaction from the target function (MessageBoxA).
    if ((dwDetourError = DetourDetach((PVOID*)&pMessageBoxA, MyMessageBoxA)) != NO_ERROR) {
        printf("[!] DetourDetach Failed With Error Code: %d \n", GetLastError());
        return FALSE;
    }

    // Commit the current transaction to finalize the process of detaching the detour (unhook).
    if ((dwDetourError = DetourTransactionCommit()) != NO_ERROR) {
        printf("[!] DetourTransactionCommit Failed With Error: %d \n", dwDetourError);
        return FALSE;
    }
    return TRUE;
}

// Function that performs Detours hooking
BOOL Hook() {
    DWORD dwDetourError = NULL; // Variable to store Detours-related error codes.

    // Start a new transaction to begin the process of hooking the target function.
    if ((dwDetourError = DetourTransactionBegin()) != NO_ERROR) {
        printf("[!] DetourTransactionBegin Failed With Error Code: %d \n", dwDetourError);
        return FALSE;
    }

    // Update the current thread handle (handle to itself).
    if ((dwDetourError = DetourUpdateThread(GetCurrentThread())) != NO_ERROR) {
        printf("[!] DetourUpdateThread Failed With Error Code: %d \n", dwDetourError);
        return FALSE;
    }

    // Attach the hook in the transaction
    if ((dwDetourError = DetourAttach((PVOID*)&pMessageBoxA, MyMessageBoxA)) != NO_ERROR) {
        printf("[!] DetourAttach Failed With Error Code: %d \n", dwDetourError);
        return FALSE;
    }

    // API Hooking is performed here after the commit
    if ((dwDetourError = DetourTransactionCommit()) != NO_ERROR) {
        printf("[!] DetourTransactionCommit Failed With Error Code: %d \n", dwDetourError);
        return FALSE;
    }
    return TRUE;
}

int main() {
    // Original MessageBoxA call
    MessageBoxA(NULL, "Original MessageBox", "Original", MB_OK);

    printf("[+] Press <Enter> To Start API Hooking\n");
    getchar();

    // Attempt API hooking
    if (!Hook()) {
        printf("[!] API Hooking Failed!\n");
        return 1;
    }

    // MessageBoxA test, it should not be able to run since it's hooked
    MessageBoxA(NULL, "0xBinary", "MessageBox", MB_OK);

    printf("[+] Press <Enter> To Unhook \n");
    getchar();

    // Attempt to unhook
    if (!Unhook()) {
        printf("[!] Unhook Failed \n");
        return 1;
    }

    // MessageBoxA test, you should be able to see this messagebox
    MessageBoxA(NULL, "Unhooking - Done", "Unhook MessageBox", MB_OK);

    printf("[+] Press <Enter> To Quit ... ");
    getchar();

    return 0;
}
