#include <Windows.h>
#include <stdio.h>
#include "Structures.h"

// This function simulates a fast-forward delay in execution by checking the time difference
// If the delay is less than 1000 milliseconds, it considers the delay successful
BOOL DelayFastForward() {
    DWORD Time1 = GetTickCount64();
    DWORD Time2 = GetTickCount64();

    // Check if the delay has occurred (at least 1000 milliseconds)
    if ((DWORD)(Time1 - Time2) < 1000) {
        printf("\t[*] Time1 - Time2 = %d \n", (DWORD)(Time1 - Time2));
        return FALSE;
    }
    return TRUE;
}

// This function uses WaitForSingleObject to introduce a delay in execution
// It creates an event and waits for a specified number of milliseconds
// If the wait is successful, and the expected time has passed, it considers the delay successful
BOOL DelayExecutionWFSO() {
    FLOAT dwMinutes = 0;
    DWORD Time1, Time2 = 0;
    DWORD dwMilliseconds = (DWORD)(dwMinutes * 60000);
    HANDLE hEvent = CreateEvent(NULL, NULL, NULL, NULL);

    Time1 = GetTickCount64();

    // Wait for dwMilliseconds.
    if (WaitForSingleObject(hEvent, dwMilliseconds) == WAIT_FAILED) {
        printf("[!] WaitForSingleObject has failed with error code: %d \n", GetLastError());
        return FALSE;
    }

    Time2 = GetTickCount64();

    // Check if the wait time is at least the specified number of milliseconds
    if ((DWORD)(Time2 - Time1) < dwMilliseconds) {
        printf("\t[!] Sandbox Detected \n");
        printf("[!] Time1: %d - Time2: %d: \n", Time1, Time2);
        return FALSE;
    }
    return TRUE;
}

// Function uses the native API from WaitForSingleObject
// Converts minutes to milliseconds, creates an event handle for synchronization
// Calls NtWaitForSingleObject from NTDLL.DLL, measures time, and checks for sandbox detection
BOOL NativeWFSO() {
    // Converting minutes to milliseconds
    DWORD dwMinutes = NULL;
    DWORD dwMilliSeconds = dwMinutes * 60000;

    // Create an event handle for synchronization
    HANDLE hEvent = CreateEvent(NULL, NULL, NULL, NULL);

    // Initialize variables for delay calculation
    LONGLONG Delay = NULL;
    NTSTATUS STATUS = NULL;
    LARGE_INTEGER DelayInterval = { 0 };

    // Get the function pointer for NtWaitForSingleObject
    fnNtWaitForSingleObject pNtWaitForSingleObject = (fnNtWaitForSingleObject)GetProcAddress(GetModuleHandle(L"NTDLL.DLL"), "NtWaitForSingleObject");

    // Initialize variables for measuring time
    DWORD Time1, Time2 = 0;

    // Convert from milliseconds to 100-nanosecond units
    Delay = dwMilliSeconds * 10000;
    DelayInterval.QuadPart = -Delay;

    // Retrieve the number of milliseconds since the system started
    Time1 = GetTickCount64();

    // Check if NtWaitForSingleObject ran into an error
    if ((STATUS = pNtWaitForSingleObject(hEvent, FALSE, &DelayInterval)) != 0x00 && STATUS != STATUS_TIMEOUT) {
        // Display an error message if NtWaitForSingleObject fails
        printf("[!] NtWaitForSingleObject Failed With Error Code: 0x%0.10X \n", STATUS);
        return FALSE;
    }

    // Retrieve the number of milliseconds since the system started
    Time2 = GetTickCount64();

    // Compare two timestamps to check for a potential sandbox environment
    if ((DWORD)(Time2 - Time1) < dwMilliSeconds) {
        // Display a message indicating the detection of a sandbox
        printf("\t[!] Sandbox Detected\n");
        printf("[!] Time1: %d - Time2: %d: \n", Time1, Time2);
        return FALSE;
    }

    // Close the event handle to clean up resources
    CloseHandle(hEvent);
    return TRUE;
}

int main() {
    printf("[--] Trying To Identify Sandbox ... \n");

    // Check for a fast-forward delay
    if (!DelayFastForward()) {
        printf("[+] No Sandbox Detected \n");
    }

    // Check for a WaitForSingleObject delay
    if (!DelayExecutionWFSO()) {
        printf("[+] No Sandbox Detected \n");
    }

    // Check Native WaitForSingleObject delay
    if (!NativeWFSO()) {
        printf("[+] No Sandbox Detected");
    }
    return 0;
}
